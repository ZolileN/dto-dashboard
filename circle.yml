machine:
  ruby:
    version: 2.3.1
  node:
    version: 6.3.0
  post:
    # Install Cloud Foundry command line client for deployment
    # - "curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'"
    - "curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&version=6.17.0&source=github'"
    - sudo dpkg -i cf-cli_amd64.deb

dependencies:
  pre:
    - npm uninstall -g strip-ansi which
    - npm ls -gp --depth=0 | awk -F/ '/node_modules/ && !/\/npm$/ {print $NF}' | xargs npm -g rm
    - rm -rf node_modules
    - npm cache clean
    - npm install -g strip-ansi which semver
    - npm install -g yarn
    - yarn cache clean
    - yarn install
    - yarn build
    - bundle install
  override:
    # - noop
  post:
    # - noop

test:
  override:
    - yarn test
    - bundle exec rspec --exclude-pattern "features/**"
    - bundle exec rspec spec/features

deployment:
  development:
    branch: master
    owner: AusDTO
    commands:
      - cf api $CF_API_DEV &> /dev/null
      - cf auth $CF_USER_DEV $CF_PASSWORD_DEV &> /dev/null
      - cf target -o $CF_ORG_DEV &> /dev/null
      - cf target -s $CF_SPACE_DEV &> /dev/null
      - ./bin/ci-deploy.sh

  staging:
    branch: staging
    owner: AusDTO
    commands:
      - cf api $CF_API_DEV &> /dev/null
      - cf auth $CF_USER_DEV $CF_PASSWORD_DEV &> /dev/null
      - cf target -o $CF_ORG_DEV &> /dev/null
      - cf target -s $CF_SPACE_STAGING &> /dev/null
      - ./bin/ci-deploy-staging.sh
      - ./bin/ci-deploy-newrelic.sh

  production:
    tag: /release-.*/
    owner: AusDTO
    commands:
      - cf api $CF_API_PROD &> /dev/null
      - cf auth $CF_USER_PROD $CF_PASSWORD_PROD &> /dev/null
      - cf target -o $CF_ORG_PROD &> /dev/null
      - cf target -s $CF_SPACE_PROD &> /dev/null
      - ./bin/ci-deploy-prod.sh
      - ./bin/ci-deploy-newrelic.sh
