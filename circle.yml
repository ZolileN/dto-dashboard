machine:
  node:
    version: 6.0.0
  services:
    - docker
  post:
    # Install Cloud Foundry command line client for deployment
    # - "curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'"
    - "curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&version=6.17.0&source=github'"
    - sudo dpkg -i cf-cli_amd64.deb
    # AWS cli (used for docker push to ecr)
    - pip install awscli
    # AWS ECS cli (used for deploying ECS services)
    - sudo curl -o /usr/local/bin/ecs-cli https://s3.amazonaws.com/amazon-ecs-cli/ecs-cli-linux-amd64-latest
    - sudo chmod +x /usr/local/bin/ecs-cli
    - /usr/local/bin/ecs-cli --version
  environment:
    DB_CONNECT: postgres://ubuntu:@127.0.0.1:5432/circle_test
database:
  pre:
    - npm run resetdb
dependencies:
  pre:
    - sudo curl --output /usr/local/bin/phantomjs https://s3.amazonaws.com/circle-downloads/phantomjs-2.1.1
    - sudo chmod a+x /usr/local/bin/phantomjs
deployment:
  development:
    branch: master
    owner: AusDTO
    commands:
      - cf api $CF_API_DEV &> /dev/null
      - cf auth $CF_USER_DEV $CF_PASSWORD_DEV &> /dev/null
      - cf target -o $CF_ORG_DEV &> /dev/null
      - cf target -s $CF_SPACE_DEV &> /dev/null
      - ./bin/cideploy.sh

  staging:
    branch: staging
    owner: AusDTO
    commands:
      - cf api $CF_API_DEV &> /dev/null
      - cf auth $CF_USER_DEV $CF_PASSWORD_DEV &> /dev/null
      - cf target -o $CF_ORG_DEV &> /dev/null
      - cf target -s $CF_SPACE_STAGING &> /dev/null
      - ./bin/cideploy-staging.sh
      
  production:
    tag: /release-.*/
    owner: AusDTO
    commands:
      - cf api $CF_API_PROD &> /dev/null
      - cf auth $CF_USER_PROD $CF_PASSWORD_PROD &> /dev/null
      - cf target -o $CF_ORG_PROD &> /dev/null
      - cf target -s $CF_SPACE_PROD &> /dev/null
      - ./bin/cideploy-prod.sh
      # build monitoring image
      - DOCKERFILE_PATH=./monitoring/Dockerfile DOCKER_IMAGE_NAME=dashboard-gov-au ./bin/ci-monitor-build.sh
      - DOCKER_COMPOSE_FILE_PATH=./monitoring/docker-compose-ecs.yml DOCKER_IMAGE_NAME=dashboard-gov-au DOCKER_CONTAINER_NAME=dashboard-gov-au ./bin/ci-monitor-deploy.sh
